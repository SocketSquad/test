name: CD Pipeline
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [ "main" ]

env:
  SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Check Environment Variables
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "DATABASE_URL is not set"
            exit 1
          fi
          
      - name: Pull Docker image
        run: |
          echo "Logging into Docker Hub..."
          sudo docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          echo "Pulling latest Docker image..."
          sudo docker pull echaf/nexus-app-back:latest
          
      - name: Stop Old Container
        run: |
          echo "Stopping old container if exists..."
          sudo docker rm -f nexus-app-back-container || true
          
      - name: Run New Docker Container
        id: run-container
        run: |
          echo "Starting new container with DATABASE_URL..."
          sudo docker run -d \
            -p 3001:3001 \
            --name nexus-app-back-container \
            -e "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            -e PORT=3001 \
            echaf/nexus-app-back:latest
          
      - name: Check Container Logs
        run: |
          echo "Waiting for container to start..."
          sleep 5
          echo "Container logs:"
          sudo docker logs nexus-app-back-container